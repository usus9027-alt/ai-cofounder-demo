name: ğŸ§ª Test AI Co-founder Platform

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 1' # Weekly tests

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: ğŸ” HTML Validation
      run: |
        echo "ğŸ” Validating HTML structure..."
        
        # Check if index.html exists
        if [ ! -f index.html ]; then
          echo "âŒ index.html not found"
          exit 1
        fi
        
        # Basic HTML structure validation
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… DOCTYPE declaration found"
        else
          echo "âŒ DOCTYPE declaration missing"
          exit 1
        fi
        
        if grep -q "<html" index.html; then
          echo "âœ… HTML tag found"
        else
          echo "âŒ HTML tag missing"
          exit 1
        fi
        
        if grep -q "<head>" index.html; then
          echo "âœ… Head section found"
        else
          echo "âŒ Head section missing"
          exit 1
        fi
        
        if grep -q "<body>" index.html; then
          echo "âœ… Body section found"
        else
          echo "âŒ Body section missing"
          exit 1
        fi
        
        echo "âœ… HTML structure validation passed"
        
    - name: ğŸ¨ CSS Validation
      run: |
        echo "ğŸ¨ Validating CSS dependencies..."
        
        # Check for Tailwind CSS
        if grep -q "tailwindcss" index.html; then
          echo "âœ… Tailwind CSS found"
        else
          echo "âŒ Tailwind CSS not found"
          exit 1
        fi
        
        # Check for Font Awesome
        if grep -q "font-awesome" index.html; then
          echo "âœ… Font Awesome found"
        else
          echo "âŒ Font Awesome not found"
          exit 1
        fi
        
        echo "âœ… CSS dependencies validation passed"
        
    - name: âš¡ JavaScript Validation
      run: |
        echo "âš¡ Validating JavaScript dependencies..."
        
        # Check for Fabric.js
        if grep -q "fabric" index.html; then
          echo "âœ… Fabric.js found"
        else
          echo "âŒ Fabric.js not found"
          exit 1
        fi
        
        # Check for basic JavaScript structure
        if grep -q "<script>" index.html; then
          echo "âœ… JavaScript code found"
        else
          echo "âŒ JavaScript code missing"
          exit 1
        fi
        
        echo "âœ… JavaScript validation passed"
        
    - name: ğŸ“± Responsive Design Check
      run: |
        echo "ğŸ“± Checking responsive design..."
        
        # Check for viewport meta tag
        if grep -q "viewport" index.html; then
          echo "âœ… Viewport meta tag found"
        else
          echo "âŒ Viewport meta tag missing"
          exit 1
        fi
        
        # Check for responsive classes
        if grep -q "lg:" index.html; then
          echo "âœ… Responsive classes found"
        else
          echo "âš ï¸ No responsive classes found"
        fi
        
        echo "âœ… Responsive design check passed"
        
    - name: ğŸ”’ Security Check
      run: |
        echo "ğŸ”’ Running security checks..."
        
        # Check for external CDN links (should be HTTPS)
        if grep -q "https://" index.html; then
          echo "âœ… HTTPS links found"
        else
          echo "âš ï¸ No HTTPS links found"
        fi
        
        # Check for potential XSS vulnerabilities
        if grep -q "innerHTML" index.html; then
          echo "âš ï¸ innerHTML usage detected - ensure proper sanitization"
        else
          echo "âœ… No innerHTML usage detected"
        fi
        
        echo "âœ… Security check completed"
        
    - name: ğŸ“Š Performance Check
      run: |
        echo "ğŸ“Š Checking performance optimizations..."
        
        # Check file size
        file_size=$(wc -c < index.html)
        echo "ğŸ“„ index.html size: $file_size bytes"
        
        if [ $file_size -lt 100000 ]; then
          echo "âœ… File size is reasonable"
        else
          echo "âš ï¸ File size is large ($file_size bytes)"
        fi
        
        # Check for minified resources
        if grep -q "min.js" index.html; then
          echo "âœ… Minified JavaScript found"
        else
          echo "âš ï¸ No minified JavaScript found"
        fi
        
        echo "âœ… Performance check completed"
        
    - name: ğŸ§ª Functional Tests
      run: |
        echo "ğŸ§ª Running functional tests..."
        
        # Check for essential functions
        functions=("createCanvasObject" "sendMessage" "addMessageToChat" "generateAIResponse")
        
        for func in "${functions[@]}"; do
          if grep -q "function $func" index.html; then
            echo "âœ… Function $func found"
          else
            echo "âŒ Function $func not found"
            exit 1
          fi
        done
        
        # Check for event listeners
        if grep -q "addEventListener" index.html; then
          echo "âœ… Event listeners found"
        else
          echo "âŒ No event listeners found"
          exit 1
        fi
        
        echo "âœ… Functional tests passed"
        
    - name: ğŸ“‹ Generate Test Report
      run: |
        echo "# ğŸ§ª Test Report" > test-report.md
        echo "=================" >> test-report.md
        echo "" >> test-report.md
        echo "**Test Date:** $(date)" >> test-report.md
        echo "**Commit:** ${{ github.sha }}" >> test-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> test-report.md
        echo "" >> test-report.md
        echo "## âœ… Test Results" >> test-report.md
        echo "- HTML Structure: âœ… PASSED" >> test-report.md
        echo "- CSS Dependencies: âœ… PASSED" >> test-report.md
        echo "- JavaScript Dependencies: âœ… PASSED" >> test-report.md
        echo "- Responsive Design: âœ… PASSED" >> test-report.md
        echo "- Security: âœ… PASSED" >> test-report.md
        echo "- Performance: âœ… PASSED" >> test-report.md
        echo "- Functional Tests: âœ… PASSED" >> test-report.md
        echo "" >> test-report.md
        echo "## ğŸ‰ All Tests Passed!" >> test-report.md
        
    - name: ğŸ“¤ Upload Test Report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.md
        retention-days: 30
        
    - name: âœ… Tests Completed
      run: |
        echo "ğŸ‰ All tests completed successfully!"
        echo "ğŸ“Š Test report generated"
        echo "ğŸš€ Platform is ready for deployment"
